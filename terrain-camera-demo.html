<html>

<head>
	<title>POI-Client Demo</title>

	<link rel="stylesheet" type="text/css" media="all" href="styles.css"/>

	<script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="js/xml3d-latest-dev.js"></script>
	<script type="text/javascript" src="js/camera.js"></script>
	<script type="text/javascript" src="js/overlay-shader.js"></script>
	<script type="text/javascript" src="js/xml3d-geo.js"></script>
	<script type="text/javascript" src="js/xml3d-poi.js"></script>
	<script type="text/javascript" src="js/xml3d-animation.js"></script>
    <script type="text/javascript" src="js/xml3d-dynamic-terrain.js"></script>
    <script type="text/javascript" src="js/3d-map-tiles.js"></script>
	<script type="text/javascript" src="js/2d-bbox.js"></script>
	<script type="text/javascript" src="js/frustum.js"></script>
	<script type="text/javascript" src="js/chart.js"></script>
    <script type="text/javascript" src="config.js"></script>
	
	<script type="text/javascript">
	
		var statisticsData = {
			labels : ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
			datasets : [
				{
					
					fillColor : "rgba(172,194,132,0.1)",
					strokeColor : "#ACC26D",
					pointColor : "#fff",
					pointStrokeColor : "#9DB86D",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					fillColor : "rgba(179,12,12,0.1)",
					strokeColor : "#B43333",
					pointColor : "#fff",
					pointStrokeColor : "#B30C0C",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					fillColor : "rgba(19,64,177,0.1)",
					strokeColor : "#244CB1",
					pointColor : "#fff",
					pointStrokeColor : "#1340B1",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					fillColor : "rgba(224,185,11,0.1)",
					strokeColor : "#D6B72D",
					pointColor : "#fff",
					pointStrokeColor : "#E0B90B",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					fillColor : "rgba(218,79,19,0.1)",
					strokeColor : "#DC6430",
					pointColor : "#fff",
					pointStrokeColor : "#DA4F13",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
							{
					fillColor : "rgba(40,40,40,0.1)",
					strokeColor : "#404040",
					pointColor : "#fff",
					pointStrokeColor : "#292929",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
							{
					fillColor : "rgba(39,156,80,0.1)",
					strokeColor : "#359F5A",
					pointColor : "#fff",
					pointStrokeColor : "#279C50",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				}
			]
		}
		

	
		var config = {
			"origin": {
				"lon": 7.041700,
				"lat": 49.254104
			},
			"level": 10,
			
			"api_tiles": global.api.ground_tiles['terrain'],
			//"api_tiles": global.api.ground_tiles['sb-local'],
			//"layers": ["plane", "buildings"],
			"layers": ["all"],
			
			/*
			"bbox": {
				"west": 7.027427,
				"south": 49.249020,
				"east": 7.053348,
				"north": 49.261289
			},
			*/
			
			"bbox": {
				"west": 0.5,
				"south": 40.75,
				"east": 15.5,
				"north": 60.75
			},
			
			"api_poi": global.api.poi
		};
		
		var geo, terrain;
		var camController;
		var chart;
		
		var framecount=0;
		var updatedtilecount=0;
		var newtiles=0;
		var reusedtiles=0;
		
		function onload()
		{
			var charts = document.getElementById('charts').getContext('2d');
			chart=new Chart(charts).Line(statisticsData);
		
			var geo_tf = document.getElementById("geo_tf");
			geo = new XML3D.Geo(geo_tf, config.level, config.origin);
			
			
			var ground_group = document.getElementById("ground");
			var ground_tf_scale = document.getElementById("ground_tf_scale");
			
			var xml3d = document.getElementById("myxml3dcanvas");
			
			camController = XML3D.Xml3dSceneController.controllers[0];
			camController.detach();
			camController.mode = "panning";
			camController.useKeys = false;
			camController.useRaycasting = true;
			camController.attach();
			updateViewportSize(xml3d);
			
			
			terrain = new XML3D.DynamicTerrain(geo, ground_group, ground_tf_scale,camController.camera, config.bbox, config.layers, config.api_tiles);
			//reuse or delete old tiles?
			terrain.mode=terrain.DELETE_OLD_TILES;
			terrain.far_plane=60000;
			
			var loader = document.getElementById("loader");

			xml3d.addEventListener('framedrawn', function( evt ) {
				//rotate();
				updateTiles();
				updateTileStatistics();
				var obj = evt.detail.count.objects;
				if (obj > (terrain.tileCount/4)){
					loader.style.display = "none";
				}	
			}, false);
		}
		
		window.addEventListener('load', onload, false);
		
		function updateViewportSize(elem) {
			camController.camera.setResolution(elem.clientWidth,elem.clientHeight);
			
			var t="Resolution: "+elem.clientWidth+"*"+elem.clientHeight;
		}
		
		function updateTiles() {	
			//create tiles
			geo.registerMoveCallback(function (pos) {
				terrain.render_tiles();
			});
		}
		
		function rotate(){
		
		var angle= 20 /(3.14159*2*360);
		var rot = new window.XML3DRotation(new window.XML3DVec3(0,1,0), angle);
		camController.camera.orientation=rot.multiply(camController.camera.orientation);
		
		}
		
		function updateTileStatistics(){
			updatedtilecount+=terrain.updatedtiles;
			reusedtiles+=terrain.reusedtiles;
			newtiles+=terrain.newtiles;
			if(framecount>20){
			framecount=0;
			chart.removeData();
			chart.addData([terrain.tileCount,terrain.maxtileCount,terrain.tiles_in_bbox,updatedtilecount,terrain.maxupdatedtiles,reusedtiles,newtiles],"");
			updatedtilecount=0;
			reusedtiles=0;
			newtiles=0;
			}
			framecount++
		}
		
	</script>
</head>

<body>
	<div id="myxml3d">
		<xml3d id="myxml3dcanvas" activeView="#defaultView" style="width: 100%; height: 60%; background-color:0xeeeeee;" onresize="updateViewportSize(this)" >

			<!-- Asset Instance -->
			<transform id="geo_tf"></transform>
			<transform id="ground_tf_scale"></transform>
			
			<group transform="#geo_tf">
				<group id="ground" transform="#ground_tf_scale"></group>
			</group>
			
			<!-- Light and View -->
			<view id="defaultView" position="0 1000 0"></view>
			
			<lightshader id="light1" script="urn:xml3d:lightshader:directional">
				<float3 name="intensity">1 1 1</float3>
			</lightshader>
			
			<group style="transform: rotateX(-90deg)" >
				<light shader="#light1"></light>
			</group>

		</xml3d>
		<div id="loader"><img src="img/ajax_loader_gray_512.gif"/></div>
		<div id="logo"><img src="img/xml3dlogo.png"/></div>

		<canvas id="charts" style="width: 100%; height: 40%;"></canvas>
		
		<div id="attribution" class="attribution">
			Data &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors
		</div>
	</div>
</body>

</html>
