<html>

<head>
	<title>POI-Client Demo</title>

	<link rel="stylesheet" type="text/css" media="all" href="styles.css"/>

	<script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="js/xml3d-dev.js"></script>
	<!-- <script type="text/javascript" src="js/overlay-shader.js"></script> -->
	<script type="text/javascript" src="js/xml3d-geo.js"></script>
	<!-- <script type="text/javascript" src="js/xml3d-poi.js"></script> -->
	<!-- <script type="text/javascript" src="js/xml3d-animation.js"></script> -->
    <script type="text/javascript" src="js/xml3d-dynamic-terrain.js"></script>
    <!-- <script type="text/javascript" src="js/3d-map-tiles.js"></script> -->
	<script type="text/javascript" src="js/2d-bbox.js"></script>
	<script type="text/javascript" src="js/frustum.js"></script>
	<script type="text/javascript" src="js/chart.js"></script>
	<script type="text/javascript" src="js/shade-0.2.js"></script>
    <script type="text/javascript" src="config.js"></script>

	<script type="text/javascript" src="tools/camera.js"></script>
	
	<script type="text/javascript">
	
		var statisticsData = {
			labels : ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
			datasets : [
				{
					//total tile count
					//bright olive
					fillColor : "rgba(172,194,132,0.1)",
					strokeColor : "#ACC26D",
					pointColor : "#fff",
					pointStrokeColor : "#9DB86D",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					//maximum tile count
					//red
					fillColor : "rgba(179,12,12,0.1)",
					strokeColor : "#B43333",
					pointColor : "#fff",
					pointStrokeColor : "#B30C0C",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					//tiles in bounding-box
					//blue
					fillColor : "rgba(19,64,177,0.1)",
					strokeColor : "#244CB1",
					pointColor : "#fff",
					pointStrokeColor : "#1340B1",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					//updated tiles per update interval
					//this includes deletes, creates and reuses
					//yelow
					fillColor : "rgba(224,185,11,0.1)",
					strokeColor : "#D6B72D",
					pointColor : "#fff",
					pointStrokeColor : "#E0B90B",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					//maximum updated tiles per FRAME
					//this includes deletes, creates and reuses
					//orange
					fillColor : "rgba(218,79,19,0.1)",
					strokeColor : "#DC6430",
					pointColor : "#fff",
					pointStrokeColor : "#DA4F13",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					//reused tiles per update interval
					//pink
					fillColor : "rgba(40,40,40,0.1)",
					strokeColor : "#DC31AF",
					pointColor : "#fff",
					pointStrokeColor : "#6E1F59",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					//new tiles per update interval
					//green
					fillColor : "rgba(39,156,80,0.1)",
					strokeColor : "#359F5A",
					pointColor : "#fff",
					pointStrokeColor : "#279C50",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					//deleted tiles per update interval
					//black
					fillColor : "rgba(40,40,40,0.1)",
					strokeColor : "#404040",
					pointColor : "#fff",
					pointStrokeColor : "#292929",
					data : [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				}
			]
		}
		

	
		var config = {
			"origin": {
				"lon": 50,
				"lat": 30
			},
			"level": 9,
			
			"api_tiles": global.api.ground_tiles['terrain3'],
			"layer": "terrain",
			
			"api_poi": global.api.poi
		};
		
		var geo, terrain;
		var camController;
		var chart;
		
		var framecount=0;
		var updatedtilecount=0;
		var newtiles=0;
		var reusedtiles=0;
		var deletedtiles=0;
		
		function onload()
		{
			var charts = document.getElementById('charts').getContext('2d');
			chart=new Chart(charts).Line(statisticsData);
		
			var geo_tf = document.getElementById("geo_tf");
			geo = new XML3D.Geo(geo_tf, config.level, config.origin);
			
			
			var ground_group = document.getElementById("ground");
			var ground_tf_scale = document.getElementById("ground_tf_scale");
			
			var xml3d = document.getElementById("myxml3dcanvas");
			
			//camController = XML3D.Xml3dSceneController.controllers[0];
			//camController.detach();
			//camController.mode = "panning";
			//camController.useKeys = false;
			//camController.useRaycasting = true;
			//camController.attach();
			//updateViewportSize(xml3d);
			
			var viewElem = document.getElementById("Camera");
			window.DemoCamera = new XML3D.StandardCamera(viewElem, {
				mode: "panning",
				updateExaminePoint: true,
				upVector: [0,1,0]
			});
			
			var options={
				"layer":config.layer
			}
			
			terrain = new XML3D.DynamicTerrain(geo, ground_group, ground_tf_scale, window.DemoCamera, config.api_tiles, options);
			//reuse or delete old tiles?
			terrain.set_mode(terrain.DELETE_OLD_TILES);
			terrain.far_plane=300000;
			terrain.wireframe=true;
			
			var loader = document.getElementById("loader");

			xml3d.addEventListener('framedrawn', function( evt ) {
				//rotate();
				updateTiles();
				updateTileStatistics();
				//var obj = evt.detail.count.objects;
				//if (obj > (terrain.tileCount/4)){
				//	loader.style.display = "none";
				//}	
			}, false);
			
			xml3d.addEventListener('load', function( evt ) {
				loader.style.display = "none";
			}, false);
			
		}
		
		window.addEventListener('load', onload, false);
		
		//function updateViewportSize(elem) {
		//	camController.camera.setResolution(elem.clientWidth,elem.clientHeight);
		//	
		//	var t="Resolution: "+elem.clientWidth+"*"+elem.clientHeight;
		//}
		
		function updateTiles() {	
			//create tiles
			geo.registerMoveCallback(function (pos) {
				terrain.render_tiles();
			});
		}
		
		function rotate(){
		
		var angle= 20 /(3.14159*2*360);
		var rot = new window.XML3DRotation(new window.XML3DVec3(0,1,0), angle);
		//TODO
		//camController.camera.orientation=rot.multiply(camController.camera.orientation);
		
		}
		
		function updateTileStatistics(){
			updatedtilecount+=terrain.updatedtiles;
			reusedtiles+=terrain.reusedtiles;
			newtiles+=terrain.newtiles;
			deletedtiles+=terrain.removedtiles;
			if(framecount>20){
			framecount=0;
			chart.removeData();
			chart.addData([terrain.tileCount,terrain.maxtileCount,terrain.tiles_in_bbox,updatedtilecount,terrain.maxupdatedtiles,reusedtiles,newtiles,deletedtiles],"");
			updatedtilecount=0;
			reusedtiles=0;
			newtiles=0;
			deletedtiles=0;
			}
			framecount++
		}
		
	</script>
	
	<script id="wireframe-script" type="application/javascript">
		function shade(env) {
			var bc = env.barycentric;
			var eps = 0.02;

			if (this.fwidth) {
				var d = this.fwidth(bc);
				var a = Math.smoothstep(new Vec3(0.0), d.mul(0.8), bc);
				var s = Math.min(Math.min(a.x(), a.y()), a.z());
				var color = Math.mix(env.lineColor || env.color.mul(0.2), env.color.mul(0.8), s);
			} else {
				if (bc.x() < eps || bc.y() < eps || bc.z() < eps) {
				var color = env.color.mul(0.2);
				} else {
					var color =  env.color.mul(0.8);
				}
			}
			return Shade.diffuse(color, env.normal);
		}
	</script>
</head>

<body>
	<div id="myxml3d">
	
		<xml3d id="myxml3dcanvas" view="#Camera" style="width: 100%; height: 80%;  background-color:0xeeeeee;">

			<defs>
				<material id="wireframe0" model="#wireframe-script">
					<float3 name="color">0.8 0.2 0.2</float3>
				</material>
				<material id="wireframe1" model="#wireframe-script">
					<float3 name="color">0.2 0.8 0.2</float3>
				</material>
				<material id="wireframe2" model="#wireframe-script">
					<float3 name="color">0.2 0.2 0.8</float3>
				</material>
				</defs>
		
			<!-- Asset Instance -->
			<transform id="geo_tf"></transform>
			<transform id="ground_tf_scale"></transform>
			
			<group transform="#geo_tf">
				<!--<group id="ground" transform="#ground_tf_scale" shader="#wireframe"></group>-->
				<group id="ground" transform="#ground_tf_scale"></group>
			</group>
			
			<!-- Light and View -->
			<view id="Camera" position="0 4000 0"></view>
			
			<light model="urn:xml3d:light:directional">
				<float3 name="intensity">1 1 1</float3>
			</light>

		</xml3d>
		<div id="loader"><img src="img/ajax_loader_gray_512.gif"/></div>
		<div id="logo"><img src="img/xml3dlogo.png"/></div>
		<canvas id="map" style="float:right;" width="150" "height="150"></canvas>
		<canvas id="charts" style=" float:left; width: 90%; height: 150px"></canvas>
		
	</div>
</body>

</html>
